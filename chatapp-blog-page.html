<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building a Real-Time Chat Application with WebSockets, Kafka and Redis | Manubhav Jain</title>
    <style>
        :root {
            --primary-color: #0a192f;
            --secondary-color: #64ffda;
            --text-color: #ccd6f6;
            --bg-color: #0a192f;
            --card-bg: #112240;
            --section-padding: 100px 0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        header {
            padding: 20px 50px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            background-color: rgba(10, 25, 47, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 16px;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: var(--secondary-color);
        }
        
        .button {
            background: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .button:hover {
            background: rgba(100, 255, 218, 0.1);
        }
        
        .blog-header {
            height: 50vh;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 80px;
            background-image: linear-gradient(rgba(10, 25, 47, 0.8), rgba(10, 25, 47, 0.8)), url('/api/placeholder/1200/600');
            background-size: cover;
            background-position: center;
        }
        
        .blog-header-content {
            text-align: center;
            max-width: 800px;
            padding: 0 20px;
        }
        
        .blog-category {
            color: var(--secondary-color);
            font-size: 16px;
            margin-bottom: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .blog-title {
            font-size: 42px;
            margin-bottom: 20px;
            color: #e6f1ff;
        }
        
        .blog-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            color: #8892b0;
            font-size: 16px;
        }
        
        .blog-meta span {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .blog-meta i {
            color: var(--secondary-color);
        }
        
        .blog-content {
            max-width: 800px;
            margin: 60px auto;
            padding: 0 20px;
        }
        
        .blog-content h2 {
            font-size: 28px;
            margin: 40px 0 20px;
            color: #e6f1ff;
        }
        
        .blog-content h3 {
            font-size: 22px;
            margin: 30px 0 15px;
            color: #e6f1ff;
        }
        
        .blog-content p {
            margin-bottom: 25px;
        }
        
        .blog-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 30px 0;
            box-shadow: 0 10px 30px -15px rgba(2, 12, 27, 0.7);
        }
        
        .blog-content pre {
            background-color: #1d2d50;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 25px 0;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .blog-content code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1d2d50;
            padding: 2px 5px;
            border-radius: 4px;
        }
        
        .blog-content ul, .blog-content ol {
            margin: 20px 0 20px 40px;
        }
        
        .blog-content li {
            margin-bottom: 10px;
        }
        
        .blog-content blockquote {
            border-left: 4px solid var(--secondary-color);
            padding-left: 20px;
            margin: 30px 0;
            font-style: italic;
            color: #8892b0;
        }
        
        .blog-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 50px 0 30px;
        }
        
        .blog-tag {
            background-color: rgba(100, 255, 218, 0.1);
            color: var(--secondary-color);
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .blog-author {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 30px;
            display: flex;
            gap: 30px;
            margin: 50px 0;
        }
        
        .author-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
        }
        
        .author-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .author-content {
            flex: 1;
        }
        
        .author-name {
            font-size: 20px;
            margin-bottom: 10px;
            color: #e6f1ff;
        }
        
        .author-bio {
            margin-bottom: 15px;
            font-size: 16px;
            color: #8892b0;
        }
        
        .author-social {
            display: flex;
            gap: 15px;
        }
        
        .author-social a {
            color: var(--text-color);
            font-size: 18px;
            transition: color 0.3s;
        }
        
        .author-social a:hover {
            color: var(--secondary-color);
        }
        
        .related-posts {
            margin: 80px 0;
        }
        
        .related-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: #e6f1ff;
        }
        
        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .related-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .related-card:hover {
            transform: translateY(-7px);
        }
        
        .related-image {
            width: 100%;
            height: 150px;
            overflow: hidden;
        }
        
        .related-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        .related-card:hover .related-image img {
            transform: scale(1.05);
        }
        
        .related-content {
            padding: 20px;
        }
        
        .related-card-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #e6f1ff;
        }
        
        .related-date {
            font-size: 14px;
            color: #8892b0;
        }
        
        footer {
            padding: 40px 20px;
            background-color: #0d1b2a;
            text-align: center;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-links a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: var(--secondary-color);
        }
        
        .footer-social {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .footer-social a {
            color: var(--text-color);
            font-size: 20px;
            transition: color 0.3s, transform 0.3s;
        }
        
        .footer-social a:hover {
            color: var(--secondary-color);
            transform: translateY(-3px);
        }
        
        .footer-text {
            color: #8892b0;
            font-size: 14px;
        }
        
        .highlight {
            color: var(--secondary-color);
        }
        
        .back-to-portfolio {
            text-align: center;
            margin: 60px 0;
        }
        
        .code-block {
            background-color: #1d2d50;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 25px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #e6f1ff;
        }
        
        .code-comment {
            color: #639599;
        }
        
        .code-keyword {
            color: #f92672;
        }
        
        .code-string {
            color: #e6db74;
        }
        
        .code-function {
            color: #66d9ef;
        }
        
        .code-block .line {
            display: block;
        }
        
        .diagram-image {
            max-width: 100%;
            margin: 30px auto;
            display: block;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 20px;
            }
            
            .blog-title {
                font-size: 32px;
            }
            
            .blog-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .blog-author {
                flex-direction: column;
                text-align: center;
            }
            
            .author-image {
                margin: 0 auto 20px;
            }
            
            .author-social {
                justify-content: center;
            }
            
            .related-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <nav>
            <a href="portfolio-webpage-with-blog.html" class="logo">MJ</a>
            <div class="nav-links">
                <a href="portfolio-webpage-with-blog.html#about">About</a>
                <a href="portfolio-webpage-with-blog.html#experience">Experience</a>
                <a href="portfolio-webpage-with-blog.html#skills">Skills</a>
                <a href="portfolio-webpage-with-blog.html#projects">Projects</a>
                <a href="portfolio-webpage-with-blog.html#blog">Blog</a>
                <a href="portfolio-webpage-with-blog.html#contact">Contact</a>
            </div>
        </nav>
    </header>

    <section class="blog-header">
        <div class="blog-header-content">
            <p class="blog-category">Distributed Systems</p>
            <h1 class="blog-title">Building a Real-Time Chat Application with WebSockets, Kafka and Redis</h1>
            <div class="blog-meta">
                <span><i class="far fa-calendar-alt"></i> April 24, 2025</span>
                <span><i class="far fa-clock"></i> 10 min read</span>
                <span><i class="fas fa-tag"></i> WebSockets, Kafka, Redis</span>
            </div>
        </div>
    </section>

    <div class="blog-content">
        <h2>Introduction</h2>
        <p>
            Real-time chat is virtually any online communication that provides a real-time or live transmission of text messages from sender to receiver. A variety of software programs are available to enable real-time chat between individuals using Internet services. Chat messages are often brief so as to let other participants respond swiftly, thereby creating a feeling much like a spoken conversation. This mode of communication differentiates real-time chats from other forms of text-based online communications, including emails and Internet forums. Real-time chat uses Web-based apps, which permit communication that is usually addressed directly but is anonymous among users in a multi-user environment.
        </p>
        <p>
            WebSockets are a great fit for applications like chats or simple games. Chat sessions are usually long-lived, with the client receiving messages from other participants over a long period of time. Chat sessions are also bidirectional â€“ clients want to send chat messages, and see chat messages from others.
            Unlike regular HTTP requests, WebSocket connections can be kept open for a long time and have an easy interface for exchanging data between the client and server in the form of frames. WebSockets are also a widely supported technology. All modern browsers can work with WebSockets out of the box, and frameworks to work with WebSockets exist in many programming languages and on many platforms.
        </p>

        <h2>Prerequisite</h2>
        <p>
            Before we move on to implementation there are basic terms and technologies we need to be familiar with.
        </p>
        
        <h3>Kafka:</h3>
        <p>
            In order to handle large number of connections, we will be needing multiple instances of a server, thus there will be a need for a medium for server to server communication. In a very fast, reliable, persisted, fault-tolerance and zero downtime manner, Kafka offers a Pub-sub and queue-based messaging system. The producers send the message to a topic and the consumer can select any one of the message systems according to their wish.
        </p>
        
        <h3>Redis:</h3>
        <p>
            For keeping account of online users and managing messages between multiple servers we would be needing a fast and reliable database system. Redis delivers sub-millisecond response times, enabling millions of requests per second for real-time applications in industries like gaming, ad-tech, financial services, healthcare, and IoT. Today, Redis is one of the most popular open source engines today, named the "Most Loved" database by Stack Overflow for five consecutive years. Because of its fast performance, Redis is a popular choice for caching, session management, gaming, leaderboards, real-time analytics, geospatial, ride-hailing, chat/messaging, media streaming, and pub/sub apps.
        </p>

        <h2>Building a Chatting Application</h2>
        <p>
            Now, Since we have gotten familiar with the technologies we will be using, below is the design diagram for our application:
        </p>
        
        <img src="/api/placeholder/800/500" alt="Chat Application Architecture Diagram" class="diagram-image">
        
        <p>
            For our application, we will build a messaging server in <code>Golang</code>
        </p>

        <h3>Docker-compose setup</h3>
        <p>
            Below is the docker-compose file we will be using to set up our services:
        </p>
        
        <div class="code-block">
            <span class="line"><span class="code-keyword">version</span>: <span class="code-string">'2'</span></span>
            <span class="line"><span class="code-keyword">services</span>:</span>
            <span class="line">    <span class="code-keyword">zookeeper</span>:</span>
            <span class="line">        <span class="code-keyword">image</span>: <span class="code-string">confluentinc/cp-zookeeper:latest</span></span>
            <span class="line">    <span class="code-keyword">environment</span>:</span>
            <span class="line">        <span class="code-keyword">ZOOKEEPER_CLIENT_PORT</span>: <span class="code-string">2181</span></span>
            <span class="line">        <span class="code-keyword">ZOOKEEPER_TICK_TIME</span>: <span class="code-string">2000</span></span>
            <span class="line">    <span class="code-keyword">ports</span>:</span>
            <span class="line">        - <span class="code-string">22181:2181</span></span>
            <span class="line"></span>
            <span class="line">    <span class="code-keyword">kafka</span>:</span>
            <span class="line">        <span class="code-keyword">image</span>: <span class="code-string">confluentinc/cp-kafka:latest</span></span>
            <span class="line">        <span class="code-keyword">depends_on</span>:</span>
            <span class="line">            - <span class="code-string">zookeeper</span></span>
            <span class="line">        <span class="code-keyword">ports</span>:</span>
            <span class="line">            - <span class="code-string">9093:9093</span></span>
            <span class="line">        <span class="code-keyword">environment</span>:</span>
            <span class="line">              <span class="code-keyword">KAFKA_BROKER_ID</span>: <span class="code-string">1</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_ZOOKEEPER_CONNECT</span>: <span class="code-string">zookeeper:2181</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_ADVERTISED_LISTENERS</span>: <span class="code-string">PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>: <span class="code-string">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_INTER_BROKER_LISTENER_NAME</span>: <span class="code-string">PLAINTEXT</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span>: <span class="code-string">1</span></span>
            <span class="line">              <span class="code-keyword">KAFKA_CREATE_TOPICS</span>: <span class="code-string">my-kafka-topic</span></span>
            <span class="line">    <span class="code-keyword">redis</span>:</span>
            <span class="line">        <span class="code-keyword">image</span>: <span class="code-string">'bitnami/redis:latest'</span></span>
            <span class="line">        <span class="code-keyword">ports</span>:</span>
            <span class="line">            - <span class="code-string">"6379:6379"</span></span>
            <span class="line">        <span class="code-keyword">environment</span>:</span>
            <span class="line">            - <span class="code-string">ALLOW_EMPTY_PASSWORD=yes</span></span>
        </div>

        <p>
            In the above <code>docker-compose.yml</code> file images used:
        </p>
        <ul>
            <li>For Redis: <code>bitnami/redis:latest</code></li>
            <li>For Kafka: <code>confluentinc/cp-kafka:latest</code></li>
        </ul>
        
        <p>
            Now that we have set up out docker-compose file we need to establish our services with our server using golang.
        </p>
        
        <p>
            For this we would be using golang library:
        </p>
        <ul>
            <li>For Redis: <code>github.com/gomodule/redigo/redis</code></li>
            <li>For Kafka: <code>github.com/segmentio/kafka-go</code></li>
            <li>For Websockets: <code>github.com/gorilla/websocket</code></li>
        </ul>

        <p>
            To create a server lets create a server object to access the services:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-keyword">type</span> <span class="code-function">Server</span> <span class="code-keyword">struct</span> {</span>
            <span class="line">    userCons    <span class="code-keyword">map</span>[<span class="code-keyword">string</span>]*websocket.Conn</span>
            <span class="line">    ctx         context.Context</span>
            <span class="line">    reader      *kafka.Reader</span>
            <span class="line">    writer      *kafka.Writer</span>
            <span class="line">    mut         sync.Mutex</span>
            <span class="line">    RedisClient *redis.Client</span>
            <span class="line">}</span>
        </div>

        <p>
            To initialize these services below is the <code>InitService()</code> function:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-keyword">func</span> <span class="code-function">InitService</span>() *Server {</span>
            <span class="line">    <span class="code-keyword">return</span> &Server{</span>
            <span class="line">        userCons: <span class="code-function">make</span>(<span class="code-keyword">map</span>[<span class="code-keyword">string</span>]*websocket.Conn),</span>
            <span class="line">        ctx:      context.<span class="code-function">Background</span>(),</span>
            <span class="line">        reader: kafka.<span class="code-function">NewReader</span>(kafka.ReaderConfig{</span>
            <span class="line">            Brokers: []<span class="code-keyword">string</span>{<span class="code-string">"localhost:9093"</span>},</span>
            <span class="line">            Topic:   <span class="code-string">"my-kafka-topic"</span>,</span>
            <span class="line">            GroupID: <span class="code-string">"group1"</span>,</span>
            <span class="line">        }),</span>
            <span class="line">        writer: &kafka.Writer{</span>
            <span class="line">            Addr:     kafka.<span class="code-function">TCP</span>(<span class="code-string">"localhost:9093"</span>),</span>
            <span class="line">            Topic:    <span class="code-string">"my-kafka-topic"</span>,</span>
            <span class="line">            Balancer: &kafka.Murmur2Balancer{},</span>
            <span class="line">        },</span>
            <span class="line">        mut: sync.Mutex{},</span>
            <span class="line">        RedisClient: redis.<span class="code-function">NewClient</span>(&redis.Options{</span>
            <span class="line">            Addr:     <span class="code-string">"localhost:6379"</span>,</span>
            <span class="line">            Password: <span class="code-string">""</span>,</span>
            <span class="line">            DB:       0,</span>
            <span class="line">        }),</span>
            <span class="line">    }</span>
            <span class="line">}</span>
        </div>

        <p>
            Now that we have initialized our services, we need to create a structure to encode-decode messages.
            Below is the structure we will be using:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-keyword">type</span> <span class="code-function">UserMessage</span> <span class="code-keyword">struct</span> {</span>
            <span class="line">    User    <span class="code-keyword">string</span> `json:<span class="code-string">"user"</span>`</span>
            <span class="line">    Message <span class="code-keyword">string</span> `json:<span class="code-string">"msg"</span>`</span>
            <span class="line">}</span>
        </div>

        <p>
            The user in the structure will have recipient user ID and Message we need to send.
        </p>

        <h3>Creating WebSocket Handler</h3>
        <p>
            Now, we can start creating our handler to receive and send messages.
            Let's start with initialing a handshake using <code>Upgrade()</code> method:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-comment">// Upgrade your connection to websocket connection</span></span>
            <span class="line">conn, err := upgrades.<span class="code-function">Upgrade</span>(w, r, <span class="code-keyword">nil</span>)</span>
            <span class="line"><span class="code-keyword">if</span> err != <span class="code-keyword">nil</span> {</span>
            <span class="line">    w.<span class="code-function">WriteHeader</span>(http.StatusInternalServerError)</span>
            <span class="line">    <span class="code-keyword">return</span></span>
            <span class="line">}</span>
        </div>

        <p>
            Once handshake is done we need to check for sender user ID from parameters and mark him online. To do that we will be using Redis and userCons map to store connection object and tag user online:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-comment">// Get Sender user ID from parameter</span></span>
            <span class="line">inID := r.URL.Query().<span class="code-function">Get</span>(<span class="code-string">"user"</span>)</span>
            <span class="line"></span>
            <span class="line"><span class="code-comment">// Writing connection in user connection map and into the redis to keep account if user is online into which server</span></span>
            <span class="line">srv.mut.<span class="code-function">Lock</span>()</span>
            <span class="line">srv.userCons[inID] = conn</span>
            <span class="line">srv.RedisClient.<span class="code-function">Set</span>(inID, <span class="code-string">"true"</span>, 0)</span>
            <span class="line">srv.mut.<span class="code-function">Unlock</span>()</span>
        </div>

        <p>
            Once we mark user online we will be sending user un-recieved messages which he may got when he was offline. We are storing un-recieved messages into our Redis Database:
        </p>

        <div class="code-block">
            <span class="line"><span class="code-comment">// Sending un-recieved messages which was sent when user was offline</span></span>
            <span class="line"></span>
            <span class="line"><span class="code-comment">// Retrieving messages from Redis server</span></span>
            <span class="line">val, err := srv.RedisClient.<span class="code-function">Get</span>(inID + <span class="code-string">"msg"</span>).<span class="code-function">Result</span>()</span>
            <span class="line"><span class="code-keyword">if</span> err == <span class="code-keyword">nil</span> && val != <span class="code-string">""</span> {</span>
            <span class="line">    <span class="code-comment">// Function to send old messaged to the user</span></span>
            <span class="line">    <span class="code-keyword">go</span> srv.<span class="code-function">SendOldMsg</span>(inID, val)</span>
            <span class="line">}</span>
        </div>

        <div class="code-block">
            <span class="line"><span class="code-keyword">func</span> (srv *Server) <span class="code-function">SendOldMsg</span>(key <span class="code-keyword">string</span>, uMsgs <span class="code-keyword">string</span>) {</span>
            <span class="line">    fmt.<span class="code-function">Println</span>(<span class="code-string">"Sending old messages"</span>)</span>
            <span class="line">    <span class="code-comment">// splitting ol